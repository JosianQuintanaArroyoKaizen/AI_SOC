name: Deploy Frontend to S3

on:
  push:
    branches:
      - master
    paths:
      - 'dashboard/templates/**'
      - 'dashboard/static/**'
      - '.github/workflows/deploy-s3-frontend.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1  # Change to your region
  S3_BUCKET: ai-soc-dev-dashboard-194561596031  # From your CloudFormation template

jobs:
  deploy-frontend:
    name: Deploy Static Site to S3
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Threat Dashboard to S3
        run: |
          echo "üöÄ Deploying threat dashboard to S3 bucket: ${{ env.S3_BUCKET }}"
          
          # Get API Gateway endpoint from CloudFormation
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ai-soc-dev-dashboard \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$API_ENDPOINT" ]; then
            echo "‚ö†Ô∏è  Warning: Could not retrieve API endpoint from CloudFormation"
            echo "    Dashboard will need manual API configuration"
          else
            echo "‚úÖ Found API endpoint: $API_ENDPOINT"
            
            # Update the API URL in threats.html
            sed -i "s|: 'https://YOUR_API_ID.execute-api.YOUR_REGION.amazonaws.com'|: '${API_ENDPOINT}'|g" dashboard/templates/threats.html
          fi
          
          # Copy threats.html as index.html (main page)
          aws s3 cp dashboard/templates/threats.html s3://${{ env.S3_BUCKET }}/index.html \
            --cache-control "public, max-age=300" \
            --content-type "text/html"
          
          # Sync static assets if they exist
          if [ -d "dashboard/static" ]; then
            aws s3 sync dashboard/static/ s3://${{ env.S3_BUCKET }}/static/ \
              --delete \
              --cache-control "public, max-age=31536000"
          fi
          
          echo "‚úÖ Threat dashboard deployed successfully"

      - name: Invalidate CloudFront cache (if applicable)
        if: vars.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "  THREAT DASHBOARD DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo ""
          echo "‚úÖ S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "‚úÖ Region: ${{ env.AWS_REGION }}"
          echo ""
          
          # Get API endpoint
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ai-soc-dev-dashboard \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text 2>/dev/null || echo "Not found")
          
          WEBSITE_URL="http://${{ env.S3_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
          
          echo "üåê Dashboard URL: $WEBSITE_URL"
          echo "üîå API Endpoint: $API_ENDPOINT"
          echo ""
          echo "Deployment completed at $(date)"
          echo "=========================================="
