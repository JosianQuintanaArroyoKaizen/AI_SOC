name: Deploy Frontend to S3

on:
  push:
    branches:
      - master
    paths:
      - 'dashboard/templates/**'
      - 'dashboard/static/**'
      - '.github/workflows/deploy-s3-frontend.yml'
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1  # Your actual region
  S3_BUCKET: ai-soc-dev-dashboard-194561596031  # From your CloudFormation template
  STACK_NAME: ai-soc-dashboard-dev  # Your actual stack name

jobs:
  deploy-frontend:
    name: Deploy Static Site to S3
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Threat Dashboard to S3
        run: |
          echo "üöÄ Deploying threat dashboard to S3 bucket: ${{ env.S3_BUCKET }}"
          
          # Get API Gateway endpoint from CloudFormation
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$API_ENDPOINT" ]; then
            echo "‚ö†Ô∏è  Warning: Could not retrieve API endpoint from CloudFormation"
            echo "    Dashboard will need manual API configuration"
          else
            echo "‚úÖ Found API endpoint: $API_ENDPOINT"
            
            # Update API endpoint in the static index.html
            sed "s|https://rstevhgym8.execute-api.eu-central-1.amazonaws.com|${API_ENDPOINT}|g" \
              dashboard/static/index.html > /tmp/index_updated.html
            
            # Use the updated file
            mv /tmp/index_updated.html dashboard/static/index.html
          fi
          
          # Sync all static files including index.html to S3
          if [ -d "dashboard/static" ]; then
            aws s3 sync dashboard/static/ s3://${{ env.S3_BUCKET }}/ \
              --region ${{ env.AWS_REGION }} \
              --delete \
              --cache-control "public, max-age=300"
            
            echo "‚úÖ Synced dashboard/static/ to S3 bucket root"
          else
            echo "‚ùå Error: dashboard/static directory not found"
            exit 1
          fi
          
          echo "‚úÖ Threat dashboard deployed successfully"

      - name: Invalidate CloudFront cache (if applicable)
        if: vars.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "  THREAT DASHBOARD DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo ""
          echo "‚úÖ S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "‚úÖ Region: ${{ env.AWS_REGION }}"
          echo ""
          
          # Get API endpoint
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text 2>/dev/null || echo "Not found")
          
          WEBSITE_URL="http://${{ env.S3_BUCKET }}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
          
          echo "üåê Dashboard URL: $WEBSITE_URL"
          echo "üîå API Endpoint: $API_ENDPOINT"
          echo ""
          echo "Deployment completed at $(date)"
          echo "=========================================="
