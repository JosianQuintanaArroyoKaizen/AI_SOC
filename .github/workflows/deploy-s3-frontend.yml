name: Deploy Frontend to S3

on:
  push:
    branches:
      - master
    paths:
      - 'docs/**'
      - '.github/workflows/deploy-s3-frontend.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1  # Change to your region
  S3_BUCKET: ai-soc-dev-dashboard-194561596031  # From your CloudFormation template

jobs:
  deploy-frontend:
    name: Deploy Static Site to S3
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync docs to S3
        run: |
          echo "üöÄ Deploying frontend to S3 bucket: ${{ env.S3_BUCKET }}"
          
          # Sync all files from docs/ to S3
          aws s3 sync docs/ s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --cache-control "public, max-age=3600" \
            --exclude ".git/*" \
            --exclude "*.md"
          
          # Set specific cache control for HTML files (shorter cache)
          aws s3 sync docs/ s3://${{ env.S3_BUCKET }}/ \
            --exclude "*" \
            --include "*.html" \
            --cache-control "public, max-age=300" \
            --content-type "text/html"
          
          # Set cache control for assets (longer cache)
          aws s3 sync docs/ s3://${{ env.S3_BUCKET }}/ \
            --exclude "*" \
            --include "*.css" \
            --include "*.js" \
            --include "*.png" \
            --include "*.jpg" \
            --include "*.jpeg" \
            --include "*.gif" \
            --include "*.svg" \
            --include "*.ico" \
            --cache-control "public, max-age=31536000"

      - name: Invalidate CloudFront cache (if applicable)
        if: vars.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "  S3 FRONTEND DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo ""
          echo "‚úÖ S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "‚úÖ Region: ${{ env.AWS_REGION }}"
          echo ""
          WEBSITE_URL="http://${{ env.S3_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
          echo "üåê Website URL: $WEBSITE_URL"
          echo ""
          echo "Deployment completed at $(date)"
          echo "=========================================="
